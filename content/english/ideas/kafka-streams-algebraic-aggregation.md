---
title: "Algebraic aggregation in Kafka Streams"
date: 2019-10-17T10:45:27+02:00
draft: true
---

Kafka Streams DSL aggregation natively support so-called "incremental" or "cumulative" aggregation functions like count, sum, min, max. However, average function (a so-called "algebraic" function, cf. "Data Cube: A Relational Aggregation Operator Generalizing Group-By, Cross-Tab, and Sub-Totals") cannot be computed like this, but it can be composed of distributive functions, namely count and sum. Thus, it can be implemented in a two step approach:

```python
import matplotlib
import matplotlib.pyplot as plt
from pandas.plotting import register_matplotlib_converters
register_matplotlib_converters()
```

## Dynamic maps with `ipyleaflet`


```java
public static AggregateValueTuple airQReadingAggregator(
    String key, AirQualityReading value, AggregateValueTuple aggregate) {
    aggregate.gh_ts = key;
    aggregate.gh = key.split("#")[0];
    aggregate.ts = Long.valueOf(key.split("#")[1]);
    aggregate.count = aggregate.count + 1;
    aggregate.sum = aggregate.sum + (Double) value.getValue();
    aggregate.avg = aggregate.sum / aggregate.count;
    return aggregate;
}
```


    <IPython.core.display.Javascript object>



<img src="data:image/png;base64,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d90lbAEAAP5Dche2TU1N0dbWVrRWX18fXV1d5zzvwQcfjBdffDG6u7uFLQAAwH9IrsL25MmTUVJSEgMDA0XrHR0d0dzcfNbz3n777Vi+fHn8+uuvwhYAAOA/JldhOzY2FkmSxNDQUNF6T09PLF26dNpzDh48GFdddVV8/fXXERGpwnZycjImJiamZnR0VNgCAABkVC7Ddnh4uGh9/fr1UVdX97fjf/vtt1i+fHls2rRpai1N2HZ3d0eSJH8bYQsAAJA9uQrbmT6KfPz48UiSJEpKSqZm3rx5U2uffvrptNfxiS0AAEB+5CpsI/54eVR7e3vRWkNDw7Qvjzp9+nTs37+/aNrb26Ouri72798fP//8c6pr+h1bAACA7Mpd2J75up/+/v4oFAqxbt26qKqqiiNHjkRERFdXV6xZs+as53t5FAAAwH9L7sI2IqK3tzeqq6ujvLw8GhsbY3BwcOpnra2t0dLSctZzhS0AAMB/Sy7DdrYJWwAAgOwStikIWwAAgOwStikIWwAAgOwStikIWwAAgOwStikIWwAAgOwStikIWwAAgOwStikIWwAAgOwStikIWwAAgOwStikIWwAAgOwStikIWwAAgOwStikIWwAAgOwStikIWwAAgOwStikIWwAAgOwStikIWwAAgOwStikIWwAAgOwStikIWwAAgOwStikIWwAAgOwStikIWwAAgOwStikIWwAAgOwStikIWwAAgOwStikIWwAAgOwStikIWwAAgOwStikIWwAAgOwStikIWwAAgOwStikIWwAAgOwStikIWwAAgOwStikIWwAAgOwStikIWwAAgOwStikIWwAAgOzKZdj29vZGTU1NVFRURGNjY+zateusx27dujVWrlwZV155ZVx++eWxYsWK2L59+4yuJ2wBAACyK3dhu2XLligrK4u+vr4oFArR2dkZVVVVMTIyMu3xnZ2d8corr8Tnn38eBw8ejOeeey7Kysriiy++SH1NYQsAAJBduQvbpqamaGtrK1qrr6+Prq6u1P+MZcuWxUsvvZT6eGELAACQXbkK25MnT0ZJSUkMDAwUrXd0dERzc3Oqf8bp06fj2muvjTfeeOOsx0xOTsbExMTUjI6OClsAAICMylXYjo2NRZIkMTQ0VLTe09MTS5cuTfXP2LBhQ1xxxRXxww8/nPWY7u7uSJLkbyNsAQAAsieXYTs8PFy0vn79+qirq/vH8zdv3hwLFy6MHTt2nPM4n9gCAADkR67C9t88irxly5aorKyMjz76aMbX9Tu2AAAA2ZWrsI344+VR7e3tRWsNDQ3nfHnU5s2bY8GCBfHBBx+c1zWFLQAAQHblLmzPfN1Pf39/FAqFWLduXVRVVcWRI0ciIqKrqyvWrFkzdfzmzZujtLQ0ent749ixY1MzPj6e+prCFgAAILtyF7YREb29vVFdXR3l5eXR2NgYg4ODUz9rbW2NlpaWqf/d0tIy7YugWltbU19P2AIAAGRXLsN2tglbAACA7BK2KQhbAACA7BK2KQhbAACA7BK2KQhbAACA7BK2KQhbAACA7BK2KQhbAACA7BK2KQhbAACA7BK2KQhbAACA7BK2KQhbAACA7BK2KQhbAACA7BK2KQhbAACA7BK2KQhbAACA7BK2KQhbAACA7BK2KQhbAACA7BK2KQhbAACA7BK2KQhbAACA7BK2KQhbAACA7BK2KQhbAACA7BK2KQhbAACA7BK2KQhbAACA7BK2KQhbAACA7BK2KQhbAACA7BK2KQhbAACA7BK2KQhbAACA7BK2KQhbAACA7BK2KQhbAACA7BK2KQhbAACA7BK2KQhbAACA7Mpl2Pb29kZNTU1UVFREY2Nj7Nq165zH79y5MxobG6OioiKuv/762LRp04yuJ2wBAACyK3dhu2XLligrK4u+vr4oFArR2dkZVVVVMTIyMu3xhw8fjoULF0ZnZ2cUCoXo6+uLsrKyeP/991NfU9gCAABkV+7CtqmpKdra2orW6uvro6ura9rjn3nmmaivry9aW7t2baxYsSL1NYUtAABAduUqbE+ePBklJSUxMDBQtN7R0RHNzc3TnnP77bdHR0dH0drAwECUlpbGqVOnpj1ncnIyJiYmpubbb7+NJElidHS0aN0YY4wxxhhjzNzP6OhoJEkS4+Pj/zY7/9G/DtuxsbFIkiSGhoaK1nt6emLp0qXTnlNbWxs9PT1Fa0NDQ5EkSRw9enTac7q7uyNJEmOMMcYYY4wxOZpDhw792+z8RxcsbIeHh4vW169fH3V1ddOeU1tbGy+//HLR2p49eyJJkjh27Ni05/z1E9uRkZFIkiS+/fbbOf+bCGNmMmf+5srTBiaPY/+avI69a/I89q/J65x5yvb48eP/Njv/UW4eRf6riQm/Y0s+2bvkmf1LXtm75Jn9S17N5t69YC+Pam9vL1praGg458ujGhoaitba2tq8PIpLgr1Lntm/5JW9S57Zv+RV7sL2zNf99Pf3R6FQiHXr1kVVVVUcOXIkIiK6urpizZo1U8ef+bqfJ598MgqFQvT39/u6Hy4Z9i55Zv+SV/YueWb/kle5C9uIiN7e3qiuro7y8vJobGyMwcHBqZ+1trZGS0tL0fE7d+6MW2+9NcrLy6OmpiY2bdo0o+tNTk5Gd3d3TE5OXojbh1lj75Jn9i95Ze+SZ/YveTWbe/eChS0AAADMBWELAABArglbAAAAck3YAgAAkGvCFgAAgFzLdNj29vZGTU1NVFRURGNjY+zateucx+/cuTMaGxujoqIirr/++hm/aRkulJns3a1bt8bKlSvjyiuvjMsvvzxWrFgR27dvn8W7hf830z93z9izZ0+UlJTELbfccpHvEM5upvt3cnIynn/++bjuuuuivLw8lixZEv39/bN0t/D/Zrp333333bj55pujsrIyrr766nj00Ufjxx9/nKW7hT8MDg7GvffeG4sWLYokSeKDDz74x3MuZq9lNmzPfDduX19fFAqF6OzsjKqqqhgZGZn2+DPfjdvZ2RmFQiH6+vpm/N24cCHMdO92dnbGK6+8Ep9//nkcPHgwnnvuuSgrK4svvvhilu+cS91M9+4Z4+PjsWTJkrjrrruELXPmfPbvqlWr4rbbbosdO3bEN998E3v37o2hoaFZvGuY+d7dvXt3zJ8/P15//fU4fPhw7N69O2688ca47777ZvnOudR9/PHH8cILL8TWrVtThe3F7rXMhm1TU1O0tbUVrdXX10dXV9e0xz/zzDNRX19ftLZ27dpYsWLFRbtHmM5M9+50li1bFi+99NKFvjU4p/Pduw8++GC8+OKL0d3dLWyZMzPdv5988kn873//i59++mk2bg/OaqZ799VXX40lS5YUrW3cuDEWL1580e4R/kmasL3YvZbJsD158mSUlJTEwMBA0XpHR0c0NzdPe87tt98eHR0dRWsDAwNRWloap06dumj3Cn92Pnv3r06fPh3XXnttvPHGGxfjFmFa57t333777Vi+fHn8+uuvwpY5cz77t729Pe6444549tln45prrona2tp4+umn45dffpmNW4aIOL+9OzQ0FOXl5bFt27b4/fff4/vvv4/m5uZYu3btbNwyTCtN2F7sXstk2I6NjUWSJH97HKinpyeWLl067Tm1tbXR09NTtDY0NBRJksTRo0cv2r3Cn53P3v2rDRs2xBVXXBE//PDDxbhFmNb57N2DBw/GVVddFV9//XVEhLBlzpzP/r377rujoqIi7rnnnti7d29s27Ytqqur47HHHpuNW4aIOP//bnjvvffisssui9LS0kiSJFatWuWDHOZUmrC92L2W6bAdHh4uWl+/fn3U1dVNe05tbW28/PLLRWt79uyJJEni2LFjF+1e4c/OZ+/+2ebNm2PhwoWxY8eOi3WLMK2Z7t3ffvstli9fXvTSB2HLXDmfP3vvvPPOWLBgQYyPj0+tbd26NebNm+dTW2bN+ezdAwcOxKJFi2LDhg3x5Zdfxvbt2+Omm26Kxx9/fDZuGaaVNmwvZq9lMmw9ikxe/ZtHkbds2RKVlZXx0UcfXcxbhGnNdO8eP348kiSJkpKSqZk3b97U2qeffjpbtw7n9WfvI488EjfccEPRWqFQiCRJ4uDBgxftXuHPzmfvPvzww7F69eqitd27d3tKkTnlUeRzaGpqivb29qK1hoaGc748qqGhoWitra3Ny6OYdTPduxF/fFK7YMGCVK9Jh4tlJnv39OnTsX///qJpb2+Purq62L9/f/z888+zddsQETP/s/ett96KysrKOHHixNTahx9+GPPnz/eJLbNqpnv3/vvvjwceeKBobXh4OJIkibGxsYt2n3AuaV8edTF7LbNhe+bV5/39/VEoFGLdunVRVVUVR44ciYiIrq6uWLNmzdTxZ14f/eSTT0ahUIj+/n5f98OcmOne3bx5c5SWlkZvb28cO3Zsav78eBzMhpnu3b/yKDJzaab798SJE7F48eJYvXp1HDhwIAYHB6O2tjaeeOKJufpX4BI10737zjvvRGlpabz55ptx6NCh2LNnTyxfvjyamprm6l+BS9SJEydi3759sW/fvkiSJF577bXYt2/f1FdVzXavZTZsI/74surq6uooLy+PxsbGGBwcnPpZa2trtLS0FB2/c+fOuPXWW6O8vDxqamou6Bf+wkzMZO+2tLREkiR/m9bW1tm/cS55M/1z98+ELXNtpvv3q6++ipUrV0ZlZWUsXrw4nnrqKZ/WMidmunc3btwYy5Yti8rKyli0aFE89NBD8d13383yXXOp++yzz87537Cz3WuZDlsAAAD4J8IWAACAXBO2AAAA5JqwBQAAINeELQAAALkmbAEAAMg1YQsAAECuCVsAAAByTdgCAACQa8IWAACAXBO2AAAA5JqwBQAAINeELQAAALkmbAEAAMg1YQsAAECuCVsAAAByTdgCAACQa8IWAACAXPs/yvWDHc4vCdgAAAAASUVORK5CYII=" width="950">



    Map(basemap={'url': 'http://c.basemaps.cartocdn.com/light_all/{z}/{x}/{y}.png', 'max_zoom': 20, 'attribution':â€¦



```python

```